<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Ocorr√™ncias Fiscais - TRANSPORTADORA JPM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals & Professional Blue -->
    <!-- Application Structure Plan: A dashboard-style SPA. The structure includes: 1) A header with the title. 2) A summary section with key metrics (total issues, count per category). 3) An interactive donut chart to visualize the distribution of issues. 4) A filterable, detailed view of occurrences presented as cards. 5) A final section for strategic recommendations. This structure was chosen to transform a static report into an intuitive analytical tool. It allows users to quickly grasp the overall situation via the summary and chart, and then dive into details by interacting with the filters, which is more engaging and efficient than reading a linear document. -->
    <!-- Visualization & Content Choices: Report Info: Issue counts per category -> Goal: Inform/Compare -> Viz: Donut Chart (Chart.js) -> Interaction: Clicking a segment filters the details list. Justification: Excellent for showing parts of a whole and creating an intuitive link between summary and detail. Report Info: Detailed occurrences -> Goal: Organize/Inform -> Viz: Dynamic Card List (HTML/JS) -> Interaction: Filtered by category selection. Justification: Clear and structured presentation of complex information, avoiding user overload. Report Info: Recommendations -> Goal: Inform -> Viz: Styled list with icons (HTML/Tailwind). Justification: High readability for actionable items. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 380px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 380px;
            }
        }
        .tab-active {
            border-color: #3B82F6;
            color: #3B82F6;
            background-color: #EFF6FF;
        }
        .tab-inactive {
            border-color: transparent;
            color: #6B7280;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Painel de An√°lise de Ocorr√™ncias Fiscais</h1>
            <p class="mt-2 text-lg text-gray-600">Cliente: TRANSPORTADORA JPM</p>
        </header>

        <main>
            <!-- Summary and Chart Section -->
            <section id="summary" class="mb-12">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">Diagn√≥stico Geral dos Desvios</h2>
                    <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">Esta se√ß√£o oferece uma vis√£o geral dos problemas fiscais identificados. O gr√°fico interativo abaixo distribui as ocorr√™ncias por categoria. Clique em uma fatia do gr√°fico ou use os bot√µes de filtro para explorar os detalhes de cada tipo de problema.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
                        <div class="lg:col-span-1">
                            <div class="chart-container">
                                <canvas id="issuesChart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <!-- Summary cards will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Details Section -->
            <section id="details">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">Detalhamento das Ocorr√™ncias</h2>
                    <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">Aqui voc√™ encontra a an√°lise detalhada de cada ocorr√™ncia fiscal. Utilize os filtros para navegar entre as categorias e entender o erro, a an√°lise e a solu√ß√£o proposta para cada caso.</p>
                    
                    <div id="filters" class="flex flex-wrap justify-center gap-2 mb-8">
                        <!-- Filter buttons will be injected here -->
                    </div>

                    <div id="issues-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Issues will be dynamically injected here -->
                    </div>
                    <div id="no-results" class="hidden text-center py-12">
                        <p class="text-gray-500 text-lg">Nenhuma ocorr√™ncia encontrada para esta categoria.</p>
                    </div>
                 </div>
            </section>

            <!-- Recommendations Section -->
            <section id="recommendations" class="mt-12">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">Recomenda√ß√µes Estrat√©gicas e Pr√≥ximos Passos</h2>
                    <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">Para corrigir as falhas atuais e prevenir futuros problemas, recomendamos a implementa√ß√£o das seguintes a√ß√µes estrat√©gicas. Estas medidas s√£o cruciais para a sa√∫de fiscal da opera√ß√£o.</p>
                    <div class="space-y-6 max-w-4xl mx-auto">
                        <div class="flex items-start p-4 bg-blue-50 rounded-lg">
                            <span class="text-2xl mr-4 text-blue-600">‚öôÔ∏è</span>
                            <div>
                                <h3 class="font-semibold text-lg">Revis√£o da Parametriza√ß√£o Fiscal no Sistema</h3>
                                <p class="text-gray-700">Realizar um pente-fino no sistema de emiss√£o para corrigir as regras de tributa√ß√£o por rota (UF de origem x UF de destino), garantindo a aplica√ß√£o correta de CST, CFOP e al√≠quotas.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-blue-50 rounded-lg">
                            <span class="text-2xl mr-4 text-blue-600">‚úîÔ∏è</span>
                            <div>
                                <h3 class="font-semibold text-lg">Criar Valida√ß√µes para Subcontrata√ß√£o</h3>
                                <p class="text-gray-700">Implementar verifica√ß√µes obrigat√≥rias no sistema, como a exig√™ncia da Chave de Acesso do CT-e da contratante e a identifica√ß√£o se a contratante possui Inscri√ß√£o Estadual na origem para definir o CST/CFOP correto.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-blue-50 rounded-lg">
                             <span class="text-2xl mr-4 text-blue-600">üë®‚Äçüè´</span>
                            <div>
                                <h3 class="font-semibold text-lg">Treinamento da Equipe de Emiss√£o</h3>
                                <p class="text-gray-700">Capacitar a equipe de faturamento sobre as regras fiscais de transporte, com foco especial nas complexidades da subcontrata√ß√£o e da substitui√ß√£o tribut√°ria.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-blue-50 rounded-lg">
                            <span class="text-2xl mr-4 text-blue-600">üìã</span>
                            <div>
                                <h3 class="font-semibold text-lg">Saneamento dos Documentos Emitidos</h3>
                                <p class="text-gray-700">Avaliar junto √† contabilidade a necessidade de emitir cartas de corre√ß√£o ou CT-es de anula√ß√£o/substitui√ß√£o para os documentos com erros graves, a fim de evitar passivos fiscais.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const issuesData = [
            {
                category: 'Tributa√ß√£o Incorreta de ICMS',
                occurrence: 'Opera√ß√µes BA x BA com benef√≠cio fiscal de MG.',
                analysis: 'A legisla√ß√£o de benef√≠cio fiscal de Minas Gerais foi aplicada indevidamente a uma opera√ß√£o interna na Bahia. O CST 090 foi usado com cobran√ßa de ICMS, quando a opera√ß√£o deveria ser isenta.',
                resolution: 'Ajustar a regra fiscal: Para opera√ß√µes BA x BA, remover a men√ß√£o ao benef√≠cio de MG e aplicar o CST 040 (Isenta). A fundamenta√ß√£o legal correta √©: "Isen√ß√£o do ICMS conforme Art. 265, Inciso CXIII". O valor do ICMS deve ser R$ 0,00.',
                ctes: 'Todos os CT-es BA x BA; Exemplo: 43828'
            },
            {
                category: 'Tributa√ß√£o Incorreta de ICMS',
                occurrence: 'Opera√ß√µes interestaduais (BA x MG, MG x PA) com isen√ß√£o.',
                analysis: 'Opera√ß√µes que ligam dois estados diferentes s√£o, por regra, tributadas pelo ICMS. A isen√ß√£o (CST 040) foi aplicada de forma incorreta.',
                resolution: 'Aplicar a tributa√ß√£o padr√£o: Para estas opera√ß√µes, o CST correto √© o 000 (Tributada integralmente). O sistema deve calcular o ICMS normalmente, com a al√≠quota correspondente. Remover qualquer mensagem de isen√ß√£o.',
                ctes: '44279, 44479, 44478'
            },
            {
                category: 'Tributa√ß√£o Incorreta de ICMS',
                occurrence: 'Opera√ß√£o RN x MG com informa√ß√£o de isen√ß√£o.',
                analysis: 'A informa√ß√£o de isen√ß√£o de ICMS, provavelmente herdada de outra regra de sistema, foi inclu√≠da em uma opera√ß√£o interestadual tribut√°vel.',
                resolution: 'Remover a informa√ß√£o de isen√ß√£o: A opera√ß√£o deve ser tratada como tributada normalmente (CST 000), sem a inclus√£o de mensagens sobre benef√≠cios fiscais inexistentes para a rota.',
                ctes: '43963'
            },
            {
                category: 'Uso Inadequado de C√≥digos Fiscais',
                occurrence: 'Uso gen√©rico do CST 090 ("Outras").',
                analysis: 'O CST 090 √© um c√≥digo residual que pode gerar questionamentos por parte do fisco por sua falta de especificidade. Ele deve ser evitado sempre que houver um c√≥digo mais claro para a opera√ß√£o.',
                resolution: 'Padronizar o uso de c√≥digos espec√≠ficos: Para opera√ß√µes de transporte tributadas, o c√≥digo a ser utilizado deve ser sempre o CST 000 (Tributada integralmente), que √© claro e n√£o gera ambiguidades.',
                ctes: 'CT-es BA x BA ou BA x Outros'
            },
            {
                category: 'Uso Inadequado de C√≥digos Fiscais',
                occurrence: 'CFOP incorreto em Subcontrata√ß√£o (GO x BA).',
                analysis: 'Os CT-es foram emitidos com CFOP 6932, mas com dados de isen√ß√£o de ICMS. A an√°lise indicou que o CFOP 6932 est√° correto (pois a contratante n√£o possui IE em GO), mas a isen√ß√£o √© indevida.',
                resolution: 'Remover a informa√ß√£o de isen√ß√£o: A a√ß√£o principal √© excluir os dados da legisla√ß√£o de isen√ß√£o do ICMS destes documentos. O CFOP 6932 deve ser mantido.',
                ctes: '44177, 44379'
            },
            {
                category: 'Falhas em Opera√ß√µes de Subcontrata√ß√£o',
                occurrence: 'Falta da Chave de Acesso do CT-e da contratante (RJ x RJ/SP).',
                analysis: 'O CT-e da subcontratada (JPM) n√£o informa a chave de acesso do CT-e original (emitido pela SADA). Esta √© uma informa√ß√£o obrigat√≥ria por lei. Os CFOPs 5932/6932 tamb√©m est√£o errados.',
                resolution: '1. Informar a Chave de Acesso: O sistema deve ter um campo obrigat√≥rio para inserir a chave do CT-e da contratante. 2. Corrigir os CFOPs: Utilizar 5360 (estadual) e 6360 (interestadual).',
                ctes: 'N√£o especificado'
            },
            {
                category: 'Falhas em Opera√ß√µes de Subcontrata√ß√£o',
                occurrence: 'CFOP e CST incorretos quando a contratante tem IE no estado de origem (TO x Outros).',
                analysis: 'A opera√ß√£o foi registrada com CST 040 e CFOP 6932. No entanto, quando a transportadora contratante (ex: DACUNHA) tem Inscri√ß√£o Estadual (IE) no estado de in√≠cio do transporte (TO), a responsabilidade pelo ICMS √© dela.',
                resolution: 'Ajustar para Substitui√ß√£o Tribut√°ria: O CT-e da subcontratada (JPM) deve ser emitido com CST 060 (ICMS cobrado por substitui√ß√£o tribut√°ria) e CFOP 6360. A mensagem de isen√ß√£o de ICMS deve ser removida.',
                ctes: '44164'
            }
        ];

        let issuesChart;
        let currentFilter = 'Todos';

        const categories = ['Todos', ...new Set(issuesData.map(item => item.category))];
        
        const categoryColors = {
            'Tributa√ß√£o Incorreta de ICMS': '#3B82F6', // blue-500
            'Uso Inadequado de C√≥digos Fiscais': '#F59E0B', // amber-500
            'Falhas em Opera√ß√µes de Subcontrata√ß√£o': '#EF4444', // red-500
        };

        function renderIssues(filter = 'Todos') {
            currentFilter = filter;
            const list = document.getElementById('issues-list');
            const noResults = document.getElementById('no-results');
            list.innerHTML = '';
            
            const filteredData = filter === 'Todos' ? issuesData : issuesData.filter(item => item.category === filter);

            if (filteredData.length === 0) {
                noResults.classList.remove('hidden');
                list.classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                list.classList.remove('hidden');
            }

            filteredData.forEach(issue => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 border border-gray-200 rounded-xl p-5 flex flex-col h-full';
                card.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-gray-900">${issue.occurrence}</h3>
                    <div class="flex-grow space-y-3 text-sm">
                        <p><strong class="font-semibold text-gray-600">An√°lise do Erro:</strong> ${issue.analysis}</p>
                        <p><strong class="font-semibold text-green-700">Resolu√ß√£o Proposta:</strong> ${issue.resolution}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <p class="text-xs text-gray-500 font-medium">CT-es Afetados: ${issue.ctes}</p>
                    </div>
                `;
                list.appendChild(card);
            });
            updateFilterButtons();
        }

        function renderFilterButtons() {
            const filtersContainer = document.getElementById('filters');
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.dataset.filter = category;
                button.className = 'px-4 py-2 text-sm font-semibold border-b-2 rounded-t-md transition-colors duration-200';
                button.onclick = () => renderIssues(category);
                filtersContainer.appendChild(button);
            });
        }

        function updateFilterButtons() {
            const buttons = document.querySelectorAll('#filters button');
            buttons.forEach(button => {
                if (button.dataset.filter === currentFilter) {
                    button.classList.add('tab-active');
                    button.classList.remove('tab-inactive');
                } else {
                    button.classList.add('tab-inactive');
                    button.classList.remove('tab-active');
                }
            });
        }

        function renderSummary() {
            const container = document.getElementById('summary-cards');
            container.innerHTML = '';

            const totalCard = document.createElement('div');
            totalCard.className = 'bg-gray-100 p-5 rounded-xl border border-gray-200 col-span-1 sm:col-span-2';
            totalCard.innerHTML = `
                <p class="text-lg font-medium text-gray-600">Total de Ocorr√™ncias</p>
                <p class="text-4xl font-bold text-gray-900">${issuesData.length}</p>
            `;
            container.appendChild(totalCard);

            const counts = {};
            issuesData.forEach(d => {
                counts[d.category] = (counts[d.category] || 0) + 1;
            });

            Object.entries(counts).forEach(([category, count]) => {
                const card = document.createElement('div');
                card.className = 'p-5 rounded-xl border';
                card.style.backgroundColor = `${categoryColors[category]}1A`; // transparent version of color
                card.style.borderColor = categoryColors[category];
                card.innerHTML = `
                    <p class="text-md font-medium" style="color: ${categoryColors[category]}">${category}</p>
                    <p class="text-3xl font-bold" style="color: ${categoryColors[category]}">${count}</p>
                `;
                container.appendChild(card);
            });
        }

        function renderChart() {
            const ctx = document.getElementById('issuesChart').getContext('2d');
            const categoryCounts = categories.slice(1).map(cat => issuesData.filter(d => d.category === cat).length);
            
            issuesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.slice(1),
                    datasets: [{
                        data: categoryCounts,
                        backgroundColor: categories.slice(1).map(cat => categoryColors[cat]),
                        borderColor: '#F8F9FA',
                        borderWidth: 4,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                padding: 20,
                                font: {
                                    size: 14,
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#111827',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 10,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        label += `${context.raw} (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const label = issuesChart.data.labels[chartElement.index];
                            renderIssues(label);
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderSummary();
            renderChart();
            renderFilterButtons();
            renderIssues();
        });
    </script>
</body>
</html>
